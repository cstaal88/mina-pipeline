# .github/workflows/gist-mediacloud-fetch.yml
name: "Gist: MediaCloud News Fetch"

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch: {}

concurrency:
  group: gist-mcloud-fetch
  cancel-in-progress: true

jobs:
  fetch-and-update-gist:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      MEDIACLOUD_API_KEY: ${{ secrets.MEDIACLOUD_API_KEY }}
      GH_TOKEN: ${{ secrets.GIST_PAT }}
      GIST_ID: "d74350025ea1e600d8764aded95bb839"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install mediacloud python-dotenv
          python3 -m pip install requests beautifulsoup4 lxml tqdm tenacity typer

      - name: Run MediaCloud pipeline
        id: fetch
        continue-on-error: true
        run: |
          echo "=== Starting MediaCloud pipeline ==="
          echo "Date (UTC): $(date -u +%Y-%m-%d)"

          python3 main.py --auto || {
            exit_code=$?
            echo "Pipeline exited with code $exit_code"
          }

          echo "=== Pipeline completed ==="

      - name: Check for output file
        id: check
        run: |
          OUTPUT_FILE="/tmp/newsdata.jsonl"

          if [ -f "$OUTPUT_FILE" ]; then
            echo "has_output=true" >> $GITHUB_OUTPUT
            echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
            echo "Found: $OUTPUT_FILE"
            echo "Size: $(wc -c < "$OUTPUT_FILE") bytes"
            echo "Lines: $(wc -l < "$OUTPUT_FILE")"
          else
            echo "has_output=false" >> $GITHUB_OUTPUT
            echo "Output file not found"
          fi

      - name: Update Gist
        if: steps.check.outputs.has_output == 'true'
        run: |
          OUTPUT_FILE="${{ steps.check.outputs.output_file }}"

          echo "=== Updating Gist ==="
          gh gist edit "$GIST_ID" -f "newsdata.jsonl" "$OUTPUT_FILE"
          echo "=== Gist updated successfully ==="
          echo "URL: https://gist.github.com/$GIST_ID"

      - name: Summary
        if: always()
        run: |
          echo "================================================"
          echo "MediaCloud fetch completed"
          echo "Date: $(date -u +%Y-%m-%d' '%H:%M' UTC')"
          if [ "${{ steps.check.outputs.has_output }}" == "true" ]; then
            echo "Gist updated: https://gist.github.com/$GIST_ID"
          else
            echo "No output to upload"
          fi
          echo "================================================"
